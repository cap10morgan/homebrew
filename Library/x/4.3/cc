#!/usr/bin/ruby
#TODO make it work with our GCC
#TODO look for formula that adjust LDFLAGS/CPPFLAGS for deps and make them work
#TODO try to create /usr/local/opt before merge
#TODO? If we find -mmacosx-version-min=10.8, change sdkroot? warn visibly if no such SDK?

def ccc? flags
  flags.split('').all?{|c| ENV['HOMEBREW_CCC'].include? c } if ENV['HOMEBREW_CCC']
end
def macos
  tst = Proc.new{|v| v.strip if v =~ /10\.\d/ }
  tst.call(ENV['HOMEBREW_MACOS']) || tst.call(ENV['MACOS_DEPLOYMENT_TARGET']) || tst.call(`/usr/bin/sw_vers -productVersion`)
end
def nclt?
  $sdkroot != nil
end
def cmake_prefixes
  @prefixes ||= ENV['CMAKE_PREFIX_PATH'].split(':').reject do |path|
    case path
    when '/usr/local'
      !nclt?
    when '/usr', '/', "#$sdkroot/usr"
      true
    end
  end
end
def cflags
  if ccc? 'Ob'
    %w{-mtune=generic -Oz}
  elsif ccc? 'O'
    u = '-arch i386 -arch x86_64' if ccc? 'u'
    c = case $0.basename when 'clang', 'clang++' then '-march=native' end
    %w{-pipe -w -Os} << u << c
  else
    []
  end
end
def ldflags
  cmake_prefixes.map{|prefix| "#{prefix}/lib" }.to_flags('-L')
end
def cppflags
  all = cmake_prefixes.map{|prefix| "#{prefix}/include" }
  opt = all.select{|prefix| prefix =~ %r{^#$brewfix/opt} }
  sys = all - opt + ENV['CMAKE_INCLUDE_PATH'].split(':')
  # we want our keg-only includes to be found before system includes so that
  # they override the system options.
  sys.to_flags('-isystem') + opt.to_flags('-I')
end

class Cmd
  def initialize path, args
    @tool = path.basename.freeze
    @args = args.freeze
    @mode = case @tool
      when 'cpp' then :cpp
      when 'ld' then :ld
    when /^clang/, /^llvm/, 'gcc', 'g++', 'cc', 'c++', nil
      if args.include? '-c'
        :cc
      elsif args.include? '-E'
        :cpp
      else
        :ld # compile *and* link mode usually but args will be same
      end
    else
      abort "Unknown command: #{path}"
    end.freeze
  end
  def parsed_args
    args = []
    origargs = @args.dup
    while arg = origargs.shift
      case arg
      when '-arch', /^-Xarch_/
        origargs.shift
      when /^-g\d?/, /^-gstabs\d+/, '-gstabs+', /^-ggdb\d?/, '-gdwarf-2',
           /^-march=.+/, /^-mtune=.+/, '-m64', '-m32',
           /^-O[0-9zs]/, '-fast',
           %r{^-[IL]/opt/local}, %r{^-[IL]/sw},
           '-pedantic', '-pedantic-errors'
      when /^-W.*/
        args << arg if arg =~ /^-Wl,/
      when /^-I(.*)/
        args << arg unless cmake_prefixes.include? $1.cleanpath
      else
        args << arg
      end
    end
    args
  end
  def args
    args = if ccc? 'O' and false
      parsed_args
    else
      @args.dup
    end
    args.unshift("--sysroot=#$sdkroot") if nclt?
    case @mode
    when :cpp
      args.unshift("-E") unless args.include? '-E'
    when :cc
      args.unshift("-c") unless args.include? '-c'
    end
    case @mode
    when :cpp
      cppflags + args
    when :cc
      cflags + cppflags + args
    when :ld
      args = cflags + cppflags + args if @tool != "ld"
      ldflags + args
    end.compact
  end
  def xcrun
    # we invoke CC for all modes because build systems suck and this is more reliable
    cc = case @tool
      when 'ld', 'cpp' then ENV['CC'].basename.chuzzle || 'clang'
      else @tool
    end
    if nclt?
      %W{xcrun #{cc}}
    else
      %W{/usr/bin/#{cc}}
    end
  end
end

####################################################################### extend
class String
  def parent; File.dirname self end
  def directory?; File.directory? self end
  def basename; File.basename self end
  def chuzzle; s = chomp; s unless s.empty? end
  def cleanpath; require 'pathname'; Pathname.new(self).realpath.to_s rescue self end
end
class NilClass
  def chuzzle; end
  def directory?; false end
  def parent; end
  def split(x); [] end
end
class Array
  def to_flags prefix
    select{|path| path.directory? }.uniq.map{|path| prefix+path }
  end
end
module Kernel extend self
  alias :_exec :exec
  def exec *args
    path = File.expand_path('~/Library/Logs/Homebrew/cc.log')
    open(path, 'a'){|f| f.puts(args.join(' ')); f.puts }
    _exec *args
  end
end if ENV['HOMEBREW_LOG']

####################################################################### global
$brewfix = "#{__FILE__}/../../../../".cleanpath.freeze
$sdkroot = ENV['HOMEBREW_SDKROOT'].freeze

######################################################################### main
cmd = Cmd.new($0, ARGV)
exec *(cmd.xcrun + cmd.args)
